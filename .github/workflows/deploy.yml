name: Deploy to OCI Compute

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed

permissions:
  contents: read

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_commit.author.name != 'dependabot[bot]' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build JAR file
        run: ./gradlew clean build

      - name: Generate unique version label
        run: echo "VERSION_LABEL=sobok-app-v$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV

      - name: Build and push Docker image to Docker Hub
        env:
          DOCKER_IMAGE: hjkim4842/sobok
        run: |
          docker build -t $DOCKER_IMAGE:latest -t $DOCKER_IMAGE:${{ github.sha }} .
          echo "${{ secrets.DOCKER_HUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin
          docker push $DOCKER_IMAGE:latest
          docker push $DOCKER_IMAGE:${{ github.sha }}
          docker logout

      - name: Configure SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}

      - name: Add OCI host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.OCI_HOST }} >> ~/.ssh/known_hosts

      - name: Sync project files to OCI instance
        env:
          OCI_HOST: ${{ secrets.OCI_HOST }}
          OCI_USER: ${{ secrets.OCI_SSH_USER }}
        run: |
          rsync -az --delete --exclude '.git/' --exclude '.github/' --exclude 'build/' --exclude 'node_modules/' ./ $OCI_USER@$OCI_HOST:/var/app/current

      - name: Pause BetterStack Monitoring
        run: |
          curl --request PATCH \
          --url https://uptime.betterstack.com/api/v2/monitors/3351769 \
          --header "Authorization: Bearer ${{ secrets.BETTERSTACK_API_KEY }}" \
          --header 'Content-Type: application/json' \
          --data '{"paused": true}'

      - name: Deploy to OCI instance
        env:
          OCI_HOST: ${{ secrets.OCI_HOST }}
          OCI_USER: ${{ secrets.OCI_SSH_USER }}
          DOCKER_IMAGE: hjkim4842/sobok
        run: |
          ssh $OCI_USER@$OCI_HOST <<EOF
          set -e
          docker pull $DOCKER_IMAGE:${{ github.sha }}
          docker pull $DOCKER_IMAGE:latest
          cd /var/app/current
          docker compose down
          docker compose up -d
          EOF

      - name: Resume BetterStack Monitoring
        run: |
          sleep 30
          curl --request PATCH \
          --url https://uptime.betterstack.com/api/v2/monitors/3351769 \
          --header "Authorization: Bearer ${{ secrets.BETTERSTACK_API_KEY }}" \
          --header 'Content-Type: application/json' \
          --data '{"paused": false}'

      - name: New Relic Application Deployment Marker
        uses: newrelic/deployment-marker-action@v2.3.0
        with:
          apiKey: ${{ secrets.NEW_RELIC_API_KEY }}
          guid: ${{ secrets.NEW_RELIC_DEPLOYMENT_ENTITY_GUID }}
          version: "v${{ env.VERSION_LABEL }}"
          user: "${{ github.actor }}"
